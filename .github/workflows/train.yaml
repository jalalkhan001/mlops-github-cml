# âœ… Name of the GitHub Actions workflow shown in the "Actions" tab
name: Train and Report

# âœ… Trigger the workflow when:
# - Code is pushed to any branch
# - A pull request is created or updated
on: [push, pull_request]

jobs:
  train:
    # âœ… Use a GitHub-hosted runner with Ubuntu
    runs-on: ubuntu-latest

    # âœ… Use a container that includes DVC, Python, CML preinstalled
    container:
      image: docker://dvcorg/cml-py3:latest

    steps:
      # âœ… Step 1: Checkout the code from your GitHub repository
      - name: Checkout repo
        uses: actions/checkout@v2  # Uses the latest stable v3.x of the checkout action

      # âœ… Step 2: Run training script
      # Installs dependencies, runs model training, generates metrics.txt and plot
      - name: Run training
        run: |
          pip install -r requirements.txt  # Install Python dependencies
          python train.py                  # Run training script that outputs metrics and plot

      # âœ… Step 3: Create a report using CML and post it as a comment in the PR
      - name: CML Report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ðŸ” Built-in GitHub token to allow comment creation
        run: |
          echo "## ðŸŽ¯ Model Metrics" > report.md           # Create markdown heading
          cat metrics.txt >> report.md                     # Append model metrics
          echo "![Accuracy](./plots/accuracy.png)" >> report.md  # Embed the accuracy plot image
          cml comment create report.md                     # Use CML to post a comment in the PR or commit
